# 嵌入模型切换指南

## 理解嵌入维度

当使用不同的嵌入模型时（如从OpenAI切换到Ollama模型），你可能会遇到维度不匹配的问题。这是因为不同的模型产生不同维度的嵌入向量：

| 模型 | 维度 |
|-------|----------|
| OpenAI text-embedding-ada-002 | 1536 |
| OpenAI text-embedding-3-small | 1536 |
| OpenAI text-embedding-3-large | 3072 |
| Ollama snowflake-arctic-embed | 768 |
| Ollama nomic-embed-text | 768 |
| Ollama mxbai-embed-large | 1024 |

## 处理维度不匹配

Second Me现在包含自动检测和处理嵌入维度不匹配的功能。当你在具有不同维度的嵌入模型之间切换时，系统将：

1. 检测新嵌入模型的维度
2. 检查现有的ChromaDB集合是否具有不同的维度
3. 如果检测到不匹配，自动使用新维度重新初始化集合
4. 提供关于该过程的清晰错误消息和日志信息

## 切换模型的推荐工作流程

在具有不同维度的嵌入模型之间切换时，请遵循以下步骤：

1. 在设置中更新你的嵌入模型配置
2. 重启应用程序以确保正确初始化
3. 如果遇到任何问题，你可以手动重置向量数据库：
   - 删除`data/chroma_db`目录的内容
   - 重启应用程序

## 故障排除

系统现在在嵌入模型之间切换时自动处理维度不匹配。你会看到如下日志消息：

```
警告：现有的'documents'集合具有维度X，但当前模型需要Y
自动使用新维度重新初始化ChromaDB集合...
成功使用新维度重新初始化ChromaDB集合
```

这表明系统已检测到并自动解决了维度不匹配。如果在自动处理后仍遇到问题：

1. 检查应用程序日志中的任何错误消息
2. 如果问题持续存在，你可以手动重置向量数据库：
   - 停止应用程序
   - 删除`data/chroma_db`目录的内容
   - 重启应用程序

## 技术细节

维度不匹配处理在以下文件中实现：

- `lpm_kernel/file_data/chroma_utils.py`：包含检测模型维度和重新初始化集合的实用程序
- `lpm_kernel/file_data/embedding_service.py`：在初始化期间处理维度检查
- `docker/app/init_chroma.py`：在初始设置期间执行维度验证

系统维护已知嵌入模型到其维度的映射，对于未知模型将默认为1536（OpenAI的维度）。
